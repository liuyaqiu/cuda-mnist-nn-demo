Compiling model demo with detected GPU architecture: sm_86
/usr/local/cuda/bin/nvcc -arch=sm_86 --std=c++17 -I/usr/local/cuda/include -Iinclude -ICommon -ICommon/UtilNPP -ICommon/GL -Ilib --relocatable-device-code=true --compile src/model_demo.cu -o obj/model_demo.o
Linking model demo executable with CUDA device code
/usr/local/cuda/bin/nvcc -arch=sm_86 --std=c++17 -I/usr/local/cuda/include -Iinclude -ICommon -ICommon/UtilNPP -ICommon/GL -Ilib obj/model_demo.o obj/model.o obj/nn_utils.o obj/data_loader.o -o bin/model_demo -L/usr/local/cuda/lib64 -Llib -LCommon/lib -lcudart -lnppc -lnppial -lnppicc -lnppidei -lnppif -lnppig -lnppim -lnppist -lnppisu -lnppitc -lfreeimage -lcutensor -lm
Running model training demo
./bin/model_demo --random_seed 42 --epochs 20 --batch_size 128 --learning_rate 0.001 --max_gradient_norm 10.0 --weight_decay 0.0001
=== CUDA MNIST Neural Network Demo ===

Configuration:
  Epochs: 20
  Batch Size: 128
  Learning Rate: 0.0010
  Max Gradient Norm: 10.0000
  Weight Decay: 0.0001
  Random Seed: 42

=== CUDA Device Information ===
Device Name: NVIDIA RTX A2000 8GB Laptop GPU
Compute Capability: 8.6
Number of SMs: 20
Max Threads per Block: 1024
Max Threads per SM: 1536
Memory Clock Rate: 7001.0 MHz
Memory Bus Width: 128 bits
Peak Memory Bandwidth: 224.0 GB/s

=== Model Architecture ===
Layer Structure:
  Layer 1: 784 -> 512 (params: 401920)
  Layer 2: 512 -> 256 (params: 131328)
  Layer 3: 256 -> 128 (params: 32896)
  Layer 4: 128 -> 10 (params: 1290)

Total Parameters: 567434
Memory Required: 2.16 MB

=== Initializing Model ===
Training data path: data/input/train_data
Test data path: data/input/test_data
DataLoader initialized with input_path: data/input/train_data, validation_ratio: 0.20
DataLoader initialized with input_path: data/input/test_data, validation_ratio: 0.00
Model created with architecture: 784 -> 512 -> 256 -> 128 -> 10
Total parameters: 567434
Initializing model...
Discovering image files in: data/input/train_data
Found 60000 image files
Image dimensions: 28x28x1
Dataset initialized with 48000 training images and 12000 validation images
Discovering image files in: data/input/test_data
Found 10000 image files
Image dimensions: 28x28x1
Dataset initialized with 10000 training images and 0 validation images
Model initialized successfully.
Training dataset: 48000 samples
Validation dataset: 12000 samples
Test dataset: 10000 samples

=== Starting Training ===
Epochs: 20
Batch size: 128
Learning rate: 0.0010
Momentum: 0.9000
Weight decay: 0.0001
Gradient clipping: 10.0000
========================

Epoch 1 [======>                                           ]  13% Batch 50/375 - Loss: 2.2808 - Acc: 13.28%Epoch 1 [=============>                                    ]  26% Batch 100/375 - Loss: 2.1602 - Acc: 21.09%Epoch 1 [====================>                             ]  40% Batch 150/375 - Loss: 2.1210 - Acc: 22.66%Epoch 1 [==========================>                       ]  53% Batch 200/375 - Loss: 2.0372 - Acc: 36.72%Epoch 1 [=================================>                ]  66% Batch 250/375 - Loss: 1.9352 - Acc: 53.12%Epoch 1 [========================================>         ]  80% Batch 300/375 - Loss: 1.8322 - Acc: 53.12%Epoch 1 [==============================================>   ]  93% Batch 350/375 - Loss: 1.7869 - Acc: 61.72%Epoch 1/20 - Time: 9s - Train Loss: 2.0500 - Val Loss: 1.7746 - Val Acc: 58.46%
Epoch 2 [======>                                           ]  13% Batch 50/375 - Loss: 1.7595 - Acc: 55.47%Epoch 2 [=============>                                    ]  26% Batch 100/375 - Loss: 1.6870 - Acc: 58.59%Epoch 2 [====================>                             ]  40% Batch 150/375 - Loss: 1.6589 - Acc: 58.59%Epoch 2 [==========================>                       ]  53% Batch 200/375 - Loss: 1.5135 - Acc: 66.41%Epoch 2 [=================================>                ]  66% Batch 250/375 - Loss: 1.5578 - Acc: 66.41%Epoch 2 [========================================>         ]  80% Batch 300/375 - Loss: 1.4211 - Acc: 68.75%Epoch 2 [==============================================>   ]  93% Batch 350/375 - Loss: 1.3735 - Acc: 66.41%Epoch 2/20 - Time: 8s - Train Loss: 1.5566 - Val Loss: 1.3555 - Val Acc: 65.53%
Epoch 3 [======>                                           ]  13% Batch 50/375 - Loss: 1.3691 - Acc: 64.84%Epoch 3 [=============>                                    ]  26% Batch 100/375 - Loss: 1.2263 - Acc: 68.75%Epoch 3 [====================>                             ]  40% Batch 150/375 - Loss: 1.2437 - Acc: 64.84%Epoch 3 [==========================>                       ]  53% Batch 200/375 - Loss: 1.2313 - Acc: 65.62%Epoch 3 [=================================>                ]  66% Batch 250/375 - Loss: 1.1758 - Acc: 65.62%Epoch 3 [========================================>         ]  80% Batch 300/375 - Loss: 1.0983 - Acc: 68.75%Epoch 3 [==============================================>   ]  93% Batch 350/375 - Loss: 1.1195 - Acc: 69.53%Epoch 3/20 - Time: 8s - Train Loss: 1.2181 - Val Loss: 1.0962 - Val Acc: 67.90%
Epoch 4 [======>                                           ]  13% Batch 50/375 - Loss: 1.1059 - Acc: 66.41%Epoch 4 [=============>                                    ]  26% Batch 100/375 - Loss: 1.0311 - Acc: 67.19%Epoch 4 [====================>                             ]  40% Batch 150/375 - Loss: 1.1014 - Acc: 67.97%Epoch 4 [==========================>                       ]  53% Batch 200/375 - Loss: 1.0952 - Acc: 67.19%Epoch 4 [=================================>                ]  66% Batch 250/375 - Loss: 1.0748 - Acc: 68.75%Epoch 4 [========================================>         ]  80% Batch 300/375 - Loss: 0.9921 - Acc: 70.31%Epoch 4 [==============================================>   ]  93% Batch 350/375 - Loss: 0.9247 - Acc: 74.22%Epoch 4/20 - Time: 9s - Train Loss: 1.0195 - Val Loss: 0.9509 - Val Acc: 70.09%
Epoch 5 [======>                                           ]  13% Batch 50/375 - Loss: 1.0289 - Acc: 64.84%Epoch 5 [=============>                                    ]  26% Batch 100/375 - Loss: 0.9355 - Acc: 73.44%Epoch 5 [====================>                             ]  40% Batch 150/375 - Loss: 0.8418 - Acc: 74.22%Epoch 5 [==========================>                       ]  53% Batch 200/375 - Loss: 0.8891 - Acc: 71.88%Epoch 5 [=================================>                ]  66% Batch 250/375 - Loss: 0.9472 - Acc: 72.66%Epoch 5 [========================================>         ]  80% Batch 300/375 - Loss: 0.8444 - Acc: 71.88%Epoch 5 [==============================================>   ]  93% Batch 350/375 - Loss: 0.9388 - Acc: 71.88%Epoch 5/20 - Time: 8s - Train Loss: 0.9041 - Val Loss: 0.8611 - Val Acc: 71.88%
Epoch 6 [======>                                           ]  13% Batch 50/375 - Loss: 0.8043 - Acc: 78.12%Epoch 6 [=============>                                    ]  26% Batch 100/375 - Loss: 0.7572 - Acc: 71.88%Epoch 6 [====================>                             ]  40% Batch 150/375 - Loss: 0.8822 - Acc: 75.00%Epoch 6 [==========================>                       ]  53% Batch 200/375 - Loss: 0.9574 - Acc: 67.97%Epoch 6 [=================================>                ]  66% Batch 250/375 - Loss: 0.8701 - Acc: 75.00%Epoch 6 [========================================>         ]  80% Batch 300/375 - Loss: 0.8450 - Acc: 75.78%Epoch 6 [==============================================>   ]  93% Batch 350/375 - Loss: 0.6966 - Acc: 78.91%Epoch 6/20 - Time: 9s - Train Loss: 0.8304 - Val Loss: 0.8014 - Val Acc: 73.58%
Epoch 7 [======>                                           ]  13% Batch 50/375 - Loss: 0.8075 - Acc: 74.22%Epoch 7 [=============>                                    ]  26% Batch 100/375 - Loss: 0.8978 - Acc: 72.66%Epoch 7 [====================>                             ]  40% Batch 150/375 - Loss: 0.7484 - Acc: 81.25%Epoch 7 [==========================>                       ]  53% Batch 200/375 - Loss: 0.7465 - Acc: 79.69%Epoch 7 [=================================>                ]  66% Batch 250/375 - Loss: 0.7660 - Acc: 75.78%Epoch 7 [========================================>         ]  80% Batch 300/375 - Loss: 0.7819 - Acc: 75.78%Epoch 7 [==============================================>   ]  93% Batch 350/375 - Loss: 0.8185 - Acc: 75.78%Epoch 7/20 - Time: 8s - Train Loss: 0.7780 - Val Loss: 0.7578 - Val Acc: 75.00%
Epoch 8 [======>                                           ]  13% Batch 50/375 - Loss: 0.9141 - Acc: 69.53%Epoch 8 [=============>                                    ]  26% Batch 100/375 - Loss: 0.7870 - Acc: 75.00%Epoch 8 [====================>                             ]  40% Batch 150/375 - Loss: 0.6372 - Acc: 86.72%Epoch 8 [==========================>                       ]  53% Batch 200/375 - Loss: 0.8202 - Acc: 74.22%Epoch 8 [=================================>                ]  66% Batch 250/375 - Loss: 0.8512 - Acc: 67.19%Epoch 8 [========================================>         ]  80% Batch 300/375 - Loss: 0.6942 - Acc: 77.34%Epoch 8 [==============================================>   ]  93% Batch 350/375 - Loss: 0.7279 - Acc: 79.69%Epoch 8/20 - Time: 9s - Train Loss: 0.7383 - Val Loss: 0.7225 - Val Acc: 76.03%
Epoch 9 [======>                                           ]  13% Batch 50/375 - Loss: 0.7422 - Acc: 78.91%Epoch 9 [=============>                                    ]  26% Batch 100/375 - Loss: 0.6985 - Acc: 79.69%Epoch 9 [====================>                             ]  40% Batch 150/375 - Loss: 0.7077 - Acc: 80.47%Epoch 9 [==========================>                       ]  53% Batch 200/375 - Loss: 0.6355 - Acc: 77.34%Epoch 9 [=================================>                ]  66% Batch 250/375 - Loss: 0.7612 - Acc: 71.88%Epoch 9 [========================================>         ]  80% Batch 300/375 - Loss: 0.6003 - Acc: 83.59%Epoch 9 [==============================================>   ]  93% Batch 350/375 - Loss: 0.7978 - Acc: 77.34%Epoch 9/20 - Time: 9s - Train Loss: 0.7069 - Val Loss: 0.6942 - Val Acc: 77.06%
Epoch 10 [======>                                           ]  13% Batch 50/375 - Loss: 0.5732 - Acc: 81.25%Epoch 10 [=============>                                    ]  26% Batch 100/375 - Loss: 0.7227 - Acc: 75.78%Epoch 10 [====================>                             ]  40% Batch 150/375 - Loss: 0.7041 - Acc: 75.78%Epoch 10 [==========================>                       ]  53% Batch 200/375 - Loss: 0.5007 - Acc: 82.03%Epoch 10 [=================================>                ]  66% Batch 250/375 - Loss: 0.6641 - Acc: 77.34%Epoch 10 [========================================>         ]  80% Batch 300/375 - Loss: 0.8034 - Acc: 72.66%Epoch 10 [==============================================>   ]  93% Batch 350/375 - Loss: 0.7286 - Acc: 76.56%Epoch 10/20 - Time: 8s - Train Loss: 0.6809 - Val Loss: 0.6708 - Val Acc: 77.88%
Epoch 11 [======>                                           ]  13% Batch 50/375 - Loss: 0.6786 - Acc: 80.47%Epoch 11 [=============>                                    ]  26% Batch 100/375 - Loss: 0.5737 - Acc: 83.59%Epoch 11 [====================>                             ]  40% Batch 150/375 - Loss: 0.6467 - Acc: 81.25%Epoch 11 [==========================>                       ]  53% Batch 200/375 - Loss: 0.5959 - Acc: 81.25%Epoch 11 [=================================>                ]  66% Batch 250/375 - Loss: 0.6784 - Acc: 73.44%Epoch 11 [========================================>         ]  80% Batch 300/375 - Loss: 0.6603 - Acc: 79.69%Epoch 11 [==============================================>   ]  93% Batch 350/375 - Loss: 0.6327 - Acc: 82.81%Epoch 11/20 - Time: 9s - Train Loss: 0.6591 - Val Loss: 0.6508 - Val Acc: 78.60%
Epoch 12 [======>                                           ]  13% Batch 50/375 - Loss: 0.5343 - Acc: 82.81%Epoch 12 [=============>                                    ]  26% Batch 100/375 - Loss: 0.7912 - Acc: 75.78%Epoch 12 [====================>                             ]  40% Batch 150/375 - Loss: 0.6151 - Acc: 80.47%Epoch 12 [==========================>                       ]  53% Batch 200/375 - Loss: 0.5331 - Acc: 80.47%Epoch 12 [=================================>                ]  66% Batch 250/375 - Loss: 0.5988 - Acc: 79.69%Epoch 12 [========================================>         ]  80% Batch 300/375 - Loss: 0.6478 - Acc: 82.03%Epoch 12 [==============================================>   ]  93% Batch 350/375 - Loss: 0.6489 - Acc: 76.56%Epoch 12/20 - Time: 9s - Train Loss: 0.6402 - Val Loss: 0.6327 - Val Acc: 79.18%
Epoch 13 [======>                                           ]  13% Batch 50/375 - Loss: 0.6285 - Acc: 77.34%Epoch 13 [=============>                                    ]  26% Batch 100/375 - Loss: 0.6110 - Acc: 79.69%Epoch 13 [====================>                             ]  40% Batch 150/375 - Loss: 0.6147 - Acc: 80.47%Epoch 13 [==========================>                       ]  53% Batch 200/375 - Loss: 0.7308 - Acc: 73.44%Epoch 13 [=================================>                ]  66% Batch 250/375 - Loss: 0.5405 - Acc: 83.59%Epoch 13 [========================================>         ]  80% Batch 300/375 - Loss: 0.5811 - Acc: 82.03%Epoch 13 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5648 - Acc: 80.47%Epoch 13/20 - Time: 8s - Train Loss: 0.6239 - Val Loss: 0.6183 - Val Acc: 79.65%
Epoch 14 [======>                                           ]  13% Batch 50/375 - Loss: 0.5855 - Acc: 79.69%Epoch 14 [=============>                                    ]  26% Batch 100/375 - Loss: 0.6513 - Acc: 79.69%Epoch 14 [====================>                             ]  40% Batch 150/375 - Loss: 0.5042 - Acc: 82.81%Epoch 14 [==========================>                       ]  53% Batch 200/375 - Loss: 0.6469 - Acc: 77.34%Epoch 14 [=================================>                ]  66% Batch 250/375 - Loss: 0.6621 - Acc: 83.59%Epoch 14 [========================================>         ]  80% Batch 300/375 - Loss: 0.5180 - Acc: 77.34%Epoch 14 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5257 - Acc: 84.38%Epoch 14/20 - Time: 8s - Train Loss: 0.6092 - Val Loss: 0.6043 - Val Acc: 80.21%
Epoch 15 [======>                                           ]  13% Batch 50/375 - Loss: 0.6693 - Acc: 82.03%Epoch 15 [=============>                                    ]  26% Batch 100/375 - Loss: 0.5252 - Acc: 82.03%Epoch 15 [====================>                             ]  40% Batch 150/375 - Loss: 0.5415 - Acc: 85.16%Epoch 15 [==========================>                       ]  53% Batch 200/375 - Loss: 0.4546 - Acc: 83.59%Epoch 15 [=================================>                ]  66% Batch 250/375 - Loss: 0.5853 - Acc: 81.25%Epoch 15 [========================================>         ]  80% Batch 300/375 - Loss: 0.5897 - Acc: 82.03%Epoch 15 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5933 - Acc: 81.25%Epoch 15/20 - Time: 9s - Train Loss: 0.5964 - Val Loss: 0.5918 - Val Acc: 80.37%
Epoch 16 [======>                                           ]  13% Batch 50/375 - Loss: 0.5329 - Acc: 80.47%Epoch 16 [=============>                                    ]  26% Batch 100/375 - Loss: 0.5762 - Acc: 78.12%Epoch 16 [====================>                             ]  40% Batch 150/375 - Loss: 0.5894 - Acc: 80.47%Epoch 16 [==========================>                       ]  53% Batch 200/375 - Loss: 0.6784 - Acc: 75.00%Epoch 16 [=================================>                ]  66% Batch 250/375 - Loss: 0.5903 - Acc: 79.69%Epoch 16 [========================================>         ]  80% Batch 300/375 - Loss: 0.5912 - Acc: 80.47%Epoch 16 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5563 - Acc: 84.38%Epoch 16/20 - Time: 8s - Train Loss: 0.5846 - Val Loss: 0.5807 - Val Acc: 80.60%
Epoch 17 [======>                                           ]  13% Batch 50/375 - Loss: 0.5130 - Acc: 82.81%Epoch 17 [=============>                                    ]  26% Batch 100/375 - Loss: 0.5431 - Acc: 78.91%Epoch 17 [====================>                             ]  40% Batch 150/375 - Loss: 0.5363 - Acc: 85.16%Epoch 17 [==========================>                       ]  53% Batch 200/375 - Loss: 0.6257 - Acc: 74.22%Epoch 17 [=================================>                ]  66% Batch 250/375 - Loss: 0.5409 - Acc: 82.81%Epoch 17 [========================================>         ]  80% Batch 300/375 - Loss: 0.5305 - Acc: 84.38%Epoch 17 [==============================================>   ]  93% Batch 350/375 - Loss: 0.6288 - Acc: 79.69%Epoch 17/20 - Time: 9s - Train Loss: 0.5741 - Val Loss: 0.5707 - Val Acc: 80.88%
Epoch 18 [======>                                           ]  13% Batch 50/375 - Loss: 0.6021 - Acc: 80.47%Epoch 18 [=============>                                    ]  26% Batch 100/375 - Loss: 0.6109 - Acc: 84.38%Epoch 18 [====================>                             ]  40% Batch 150/375 - Loss: 0.6468 - Acc: 82.81%Epoch 18 [==========================>                       ]  53% Batch 200/375 - Loss: 0.5799 - Acc: 79.69%Epoch 18 [=================================>                ]  66% Batch 250/375 - Loss: 0.6397 - Acc: 85.94%Epoch 18 [========================================>         ]  80% Batch 300/375 - Loss: 0.5775 - Acc: 84.38%Epoch 18 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5054 - Acc: 84.38%Epoch 18/20 - Time: 8s - Train Loss: 0.5645 - Val Loss: 0.5614 - Val Acc: 81.14%
Epoch 19 [======>                                           ]  13% Batch 50/375 - Loss: 0.4708 - Acc: 85.16%Epoch 19 [=============>                                    ]  26% Batch 100/375 - Loss: 0.5057 - Acc: 85.94%Epoch 19 [====================>                             ]  40% Batch 150/375 - Loss: 0.4850 - Acc: 82.03%Epoch 19 [==========================>                       ]  53% Batch 200/375 - Loss: 0.5986 - Acc: 80.47%Epoch 19 [=================================>                ]  66% Batch 250/375 - Loss: 0.5674 - Acc: 80.47%Epoch 19 [========================================>         ]  80% Batch 300/375 - Loss: 0.5688 - Acc: 77.34%Epoch 19 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5275 - Acc: 84.38%Epoch 19/20 - Time: 8s - Train Loss: 0.5557 - Val Loss: 0.5537 - Val Acc: 81.33%
Epoch 20 [======>                                           ]  13% Batch 50/375 - Loss: 0.4922 - Acc: 83.59%Epoch 20 [=============>                                    ]  26% Batch 100/375 - Loss: 0.5325 - Acc: 81.25%Epoch 20 [====================>                             ]  40% Batch 150/375 - Loss: 0.6732 - Acc: 80.47%Epoch 20 [==========================>                       ]  53% Batch 200/375 - Loss: 0.5652 - Acc: 85.16%Epoch 20 [=================================>                ]  66% Batch 250/375 - Loss: 0.5584 - Acc: 78.12%Epoch 20 [========================================>         ]  80% Batch 300/375 - Loss: 0.5868 - Acc: 84.38%Epoch 20 [==============================================>   ]  93% Batch 350/375 - Loss: 0.5766 - Acc: 78.12%Epoch 20/20 - Time: 8s - Train Loss: 0.5476 - Val Loss: 0.5461 - Val Acc: 81.58%

=== Training Complete ===
Best validation accuracy: 81.5833%

=== Training Summary ===
Final Validation Accuracy: 81.5833%
Total Training Time: 176.8785 seconds
Average Time per Epoch: 8.8439 seconds

=== Evaluating on Test Set ===

=== Evaluating on Test Set ===
Test Accuracy: 80.86%
Test Loss: 0.5612
Correct: 8086/10000

Per-class accuracy:
Class 0: 79.80%
Class 1: 93.40%
Class 2: 72.80%
Class 3: 84.80%
Class 4: 75.10%
Class 5: 85.10%
Class 6: 42.70%
Class 7: 88.90%
Class 8: 92.90%
Class 9: 93.10%

=== Detailed Test Metrics ===
Overall Test Accuracy: 80.8600%
Test Loss: 0.5612
Correct Predictions: 8086/10000

Per-Class Accuracy:
  Class 0: 79.8000%
  Class 1: 93.4000%
  Class 2: 72.8000%
  Class 3: 84.8000%
  Class 4: 75.1000%
  Class 5: 85.1000%
  Class 6: 42.7000%
  Class 7: 88.9000%
  Class 8: 92.9000%
  Class 9: 93.1000%

Confusion Matrix:
          P0     P1     P2     P3     P4     P5     P6     P7     P8     P9
  T0    798     9    15    72     4     4    77     0    20     1
  T1      7   934    14    37     6     0     0     0     2     0
  T2     20     1   728    10   158     0    66     0    17     0
  T3     36    15     9   848    38     1    48     0     5     0
  T4      0     3   132    42   751     0    66     0     6     0
  T5      1     0     0     3     0   851     0    93     7    45
  T6    183     6   156    53   137     1   427     0    37     0
  T7      0     0     0     0     0    39     0   889     0    72
  T8      6     1    16     9     2    10    15    10   929     2
  T9      1     0     0     0     0    13     0    54     1   931
(T = True label, P = Predicted label)

=== Performance Metrics ===
Total Training Iterations: 7500
Total FLOPS: 3.26e+12
Training TFLOPS: 0.018
GPU Memory Used: 94.00 MB
Estimated Peak TFLOPS (FP32): 0.0
CUDA Efficiency: 447.1%

=== GPU Memory Usage ===
Total GPU Memory: 7973.69 MB
Free GPU Memory: 7784.25 MB
Used GPU Memory: 189.44 MB

=== Additional Statistics ===
Images per Second (Training): 5427.5
Milliseconds per Batch: 23.58

=== Demo Complete ===
